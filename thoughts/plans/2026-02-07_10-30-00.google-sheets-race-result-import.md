# Implementation Plan: Google Sheets Import for Race Results

## Overview

Add the ability to import race results from a public Google Sheets URL. When a user enters a valid Google Sheets URL, the system will fetch the sheet data as CSV and parse it using the existing CSV import functionality.

## Architecture Approach

**Key Insight**: Public Google Sheets can be accessed without an API key by transforming the URL to export as CSV:
- Original: `https://docs.google.com/spreadsheets/d/{SHEET_ID}/edit#gid=0`
- CSV Export: `https://docs.google.com/spreadsheets/d/{SHEET_ID}/export?format=csv&gid={GID}`

This approach:
- No Google API key required
- No OAuth flow needed
- Works for any publicly shared Google Sheet
- Reuses existing CSV parsing logic
- Backend proxies the request to avoid CORS issues

## Implementation Phases

### Phase 1: Backend - Google Sheets Fetch Service
**Agent**: `dev-be`

Create a simple service that:
1. Validates Google Sheets URL format
2. Transforms URL to CSV export format
3. Fetches the CSV content
4. Returns raw CSV string

**Files to create/modify**:
- `app/Services/GoogleSheetsService.php` (new) - Service to fetch sheet as CSV
- `app/Http/Controllers/User/GoogleSheetsController.php` (new) - API endpoint
- `routes/subdomain.php` - Add route

### Phase 2: Frontend - Google Sheets Import Component
**Agent**: `dev-fe-app`

Create a new import section in `ResultCsvImport.vue` that:
1. Accepts a Google Sheets URL
2. Calls backend to fetch the sheet as CSV
3. Populates the existing CSV textarea
4. Uses existing parse logic

**Files to modify**:
- `resources/app/js/components/result/ResultCsvImport.vue` - Add Google Sheets URL input
- `resources/app/js/services/raceResultService.ts` - Add fetch method

### Phase 3: Testing
**Agents**: `dev-be`, `dev-fe-app`

- Backend unit tests for URL validation and transformation
- Frontend unit tests for the new UI component

---

## Detailed Implementation

### Phase 1: Backend Implementation

#### 1.1 Create GoogleSheetsService

**File**: `app/Services/GoogleSheetsService.php`

```php
<?php

namespace App\Services;

use GuzzleHttp\Client;
use GuzzleHttp\Exception\GuzzleException;
use Illuminate\Support\Facades\Log;

class GoogleSheetsService
{
    private Client $client;

    public function __construct()
    {
        $this->client = new Client([
            'timeout' => 30,
            'verify' => true,
            'http_errors' => false,
        ]);
    }

    /**
     * Extract sheet ID and GID from a Google Sheets URL
     *
     * Supported formats:
     * - https://docs.google.com/spreadsheets/d/{SHEET_ID}/edit#gid={GID}
     * - https://docs.google.com/spreadsheets/d/{SHEET_ID}/edit?gid={GID}
     * - https://docs.google.com/spreadsheets/d/{SHEET_ID}/edit
     * - https://docs.google.com/spreadsheets/d/{SHEET_ID}
     *
     * @return array{sheet_id: string, gid: string}|null
     */
    public function parseSheetUrl(string $url): ?array
    {
        // Match the sheet ID from the URL
        $pattern = '/\/spreadsheets\/d\/([a-zA-Z0-9_-]+)/';
        if (!preg_match($pattern, $url, $matches)) {
            return null;
        }

        $sheetId = $matches[1];

        // Extract GID if present (defaults to 0 for first sheet)
        $gid = '0';
        if (preg_match('/[#?&]gid=(\d+)/', $url, $gidMatches)) {
            $gid = $gidMatches[1];
        }

        return [
            'sheet_id' => $sheetId,
            'gid' => $gid,
        ];
    }

    /**
     * Build the CSV export URL for a Google Sheet
     */
    public function buildCsvExportUrl(string $sheetId, string $gid = '0'): string
    {
        return "https://docs.google.com/spreadsheets/d/{$sheetId}/export?format=csv&gid={$gid}";
    }

    /**
     * Fetch a public Google Sheet as CSV
     *
     * @throws \Exception If the sheet cannot be fetched
     */
    public function fetchSheetAsCsv(string $url): string
    {
        $parsed = $this->parseSheetUrl($url);
        if ($parsed === null) {
            throw new \InvalidArgumentException('Invalid Google Sheets URL format');
        }

        $csvUrl = $this->buildCsvExportUrl($parsed['sheet_id'], $parsed['gid']);

        try {
            $response = $this->client->get($csvUrl, [
                'headers' => [
                    'Accept' => 'text/csv',
                ],
            ]);

            $statusCode = $response->getStatusCode();

            if ($statusCode === 404) {
                throw new \Exception('Google Sheet not found. Make sure the sheet exists and is publicly accessible.');
            }

            if ($statusCode !== 200) {
                Log::warning('Google Sheets fetch failed', [
                    'url' => $url,
                    'status' => $statusCode,
                ]);
                throw new \Exception('Failed to fetch Google Sheet. Please check that the sheet is publicly shared.');
            }

            $body = (string) $response->getBody();

            if (empty($body)) {
                throw new \Exception('Google Sheet is empty');
            }

            // Check if we got HTML instead of CSV (happens when sheet is not public)
            if (str_starts_with(trim($body), '<!DOCTYPE') || str_starts_with(trim($body), '<html')) {
                throw new \Exception('Cannot access Google Sheet. Please make sure the sheet is shared publicly (Anyone with the link can view).');
            }

            return $body;
        } catch (GuzzleException $e) {
            Log::error('Google Sheets fetch exception', [
                'url' => $url,
                'error' => $e->getMessage(),
            ]);
            throw new \Exception('Failed to connect to Google Sheets. Please try again.');
        }
    }
}
```

#### 1.2 Create GoogleSheetsController

**File**: `app/Http/Controllers/User/GoogleSheetsController.php`

```php
<?php

namespace App\Http\Controllers\User;

use App\Helpers\ApiResponse;
use App\Http\Controllers\Controller;
use App\Services\GoogleSheetsService;
use Illuminate\Http\JsonResponse;
use Illuminate\Http\Request;

class GoogleSheetsController extends Controller
{
    public function __construct(
        private readonly GoogleSheetsService $googleSheetsService
    ) {
    }

    /**
     * Fetch a Google Sheet as CSV
     */
    public function fetchAsCsv(Request $request): JsonResponse
    {
        $request->validate([
            'url' => ['required', 'string', 'url', 'regex:/docs\.google\.com\/spreadsheets/'],
        ], [
            'url.regex' => 'Please enter a valid Google Sheets URL',
        ]);

        try {
            $csv = $this->googleSheetsService->fetchSheetAsCsv($request->input('url'));

            return ApiResponse::success([
                'csv' => $csv,
            ]);
        } catch (\InvalidArgumentException $e) {
            return ApiResponse::error($e->getMessage(), null, 422);
        } catch (\Exception $e) {
            return ApiResponse::error($e->getMessage(), null, 400);
        }
    }
}
```

#### 1.3 Register Service in AppServiceProvider

**File**: `app/Providers/AppServiceProvider.php` (modify)

Add singleton registration:
```php
use App\Services\GoogleSheetsService;

// In register() method:
$this->app->singleton(GoogleSheetsService::class, function ($app) {
    return new GoogleSheetsService();
});
```

#### 1.4 Add Route

**File**: `routes/subdomain.php` (modify)

Add under the authenticated app subdomain routes:
```php
// Google Sheets import
Route::post('/google-sheets/fetch-csv', [GoogleSheetsController::class, 'fetchAsCsv']);
```

---

### Phase 2: Frontend Implementation

#### 2.1 Add API Service Method

**File**: `resources/app/js/services/raceResultService.ts` (or create googleSheetsService.ts)

```typescript
import { apiClient } from './api';

interface GoogleSheetsCsvResponse {
  data: {
    csv: string;
  };
}

/**
 * Fetch a public Google Sheet as CSV data
 */
export async function fetchGoogleSheetAsCsv(url: string): Promise<string> {
  const response = await apiClient.post<GoogleSheetsCsvResponse>('/api/google-sheets/fetch-csv', {
    url,
  });
  return response.data.data.csv;
}
```

#### 2.2 Modify ResultCsvImport.vue

Add a new section for Google Sheets URL input. The component will:
1. Show an input for the Google Sheets URL
2. Add a "Fetch Sheet" button
3. When clicked, fetch the CSV and populate the textarea
4. User can then use existing "Parse CSV" flow

**Changes to template**:
- Add a collapsible/accordion section for "Import from Google Sheets"
- Add URL input field with validation
- Add "Fetch from Google Sheets" button with loading state
- Show error messages for invalid URLs or fetch failures

**Changes to script**:
- Add `googleSheetsUrl` ref
- Add `isFetchingSheet` ref for loading state
- Add `sheetFetchError` ref for error display
- Add `handleFetchGoogleSheet()` function

---

### Phase 3: Testing

#### 3.1 Backend Tests

**File**: `tests/Unit/Services/GoogleSheetsServiceTest.php`

Test cases:
- `test_parses_valid_sheet_url_with_gid`
- `test_parses_valid_sheet_url_without_gid`
- `test_parses_url_with_query_param_gid`
- `test_returns_null_for_invalid_url`
- `test_builds_correct_csv_export_url`

#### 3.2 Frontend Tests

**File**: `resources/app/js/components/result/ResultCsvImport.test.ts` (modify)

Test cases:
- Shows Google Sheets import section
- Validates Google Sheets URL format
- Shows loading state while fetching
- Populates CSV textarea on successful fetch
- Shows error message on fetch failure

---

## Success Criteria

### Automated Verification:
- [x] All PHP tests pass: `.claude/support/scripts/phpunit_run_tests.sh`
- [x] All Vitest tests pass: `.claude/support/scripts/vitests_run_tests.sh`
- [x] No linting errors: `composer run phpcs`
- [x] Static analysis passes: `composer run phpstan`
- [x] JavaScript/TypeScript ESLint passes: `npm run lint`
- [x] JavaScript/TypeScript formatting passes: `npm run format`

### Manual Verification:
- [ ] Can enter a public Google Sheets URL in the race results modal
- [ ] Clicking "Fetch from Sheet" populates the CSV textarea with sheet data
- [ ] Error is shown for private/inaccessible sheets
- [ ] Error is shown for invalid URLs
- [ ] Existing CSV parsing continues to work after sheet is fetched
- [ ] Works for sheets with multiple tabs (using gid parameter)

---

## Out of Scope

- Private Google Sheets (would require OAuth)
- Google Sheets API key authentication
- Direct editing of Google Sheets
- Syncing changes back to the sheet
- Sheet selection UI for multi-sheet documents (user specifies in URL via gid)
- Caching of fetched sheets

---

## Risk Assessment

### Low Risk
- Relies on Google's stable public export API
- No API key means no credential management
- Backend proxy avoids CORS issues

### Mitigation
- Clear error messages for inaccessible sheets
- Graceful fallback to manual CSV input
- Rate limiting on the endpoint (consider adding if abuse is a concern)

---

## Dependencies

- No new npm packages required (reuses existing CSV parsing)
- No new composer packages required (GuzzleHttp already installed)
- No environment variables needed
- No database changes

---

## File Summary

### New Files:
1. `app/Services/GoogleSheetsService.php`
2. `app/Http/Controllers/User/GoogleSheetsController.php`
3. `tests/Unit/Services/GoogleSheetsServiceTest.php`

### Modified Files:
1. `app/Providers/AppServiceProvider.php` - Register service
2. `routes/subdomain.php` - Add route
3. `resources/app/js/services/raceResultService.ts` - Add fetch function
4. `resources/app/js/components/result/ResultCsvImport.vue` - Add UI
5. `resources/app/js/components/result/ResultCsvImport.test.ts` - Add tests
