# Implementation Plan: CSV Export for CrossDivisionAllTimesTable

## Overview

Add CSV export functionality to the `CrossDivisionAllTimesTable` component, following the existing pattern in `RaceEventAccordion.vue`. This will allow users to download the cross-division times data as a CSV file.

## Reference Implementation

- **Pattern source**: `resources/public/js/components/leagues/rounds/RaceEventAccordion.vue:418-541`
- **Target component**: `resources/public/js/components/leagues/rounds/CrossDivisionAllTimesTable.vue`

## Scope

### In Scope
- Add "Export Data" button to the table header
- Implement `exportToCSV()` function following the RaceEventAccordion pattern
- Export all visible columns: Position, Driver Name, Division (if present), Qualifying Time, Race Time, Fastest Lap
- Include both absolute times and gaps in export
- Add GTM analytics tracking for downloads
- Add props for filename generation (competition name, season name, round name)
- Write comprehensive unit tests

### Out of Scope
- Other export formats (PDF, Excel, etc.)
- Server-side export functionality
- Customizable column selection for export

## Implementation Phases

### Phase 1: Add Props for Filename Context

**Files**: `resources/public/js/components/leagues/rounds/CrossDivisionAllTimesTable.vue`

**Changes**:
1. Add new optional props to the interface:
   - `competitionName?: string` - For filename generation
   - `seasonName?: string` - For filename generation
   - `roundName?: string` - For filename generation (e.g., "Round 1", "Silverstone")

**Code changes**:
```typescript
interface Props {
  qualifyingResults: CrossDivisionResult[] | null;
  raceTimeResults: CrossDivisionResult[] | null;
  fastestLapResults: CrossDivisionResult[] | null;
  raceEvents: RaceEventResults[];
  divisions: Array<{ id: number; name: string }>;
  // New props for CSV export
  competitionName?: string;
  seasonName?: string;
  roundName?: string;
}

const props = withDefaults(defineProps<Props>(), {
  competitionName: '',
  seasonName: '',
  roundName: '',
});
```

### Phase 2: Add Export Button to Template

**Files**: `resources/public/js/components/leagues/rounds/CrossDivisionAllTimesTable.vue`

**Changes**:
1. Add imports for `VrlButton`, `PhDownloadSimple`, and `useGtm`
2. Wrap the table in a container with a header row containing the export button
3. Style consistently with RaceEventAccordion pattern

**Template changes**:
```vue
<template>
  <div class="cross-division-results">
    <!-- Header with export button -->
    <div class="flex items-center justify-between mb-3">
      <h4 class="font-[family-name:var(--font-display)] text-base font-semibold text-[var(--text-primary)]">
        All Times
      </h4>
      <VrlButton
        variant="secondary"
        outline
        size="sm"
        label="Export Data"
        :icon="PhDownloadSimple"
        @click="exportToCSV()"
      />
    </div>

    <VrlDataTable ... >
      <!-- existing columns -->
    </VrlDataTable>
  </div>
</template>
```

### Phase 3: Implement exportToCSV Function

**Files**: `resources/public/js/components/leagues/rounds/CrossDivisionAllTimesTable.vue`

**Changes**:
1. Import `useGtm` composable
2. Add `exportToCSV()` function following the RaceEventAccordion pattern

**Implementation details**:

```typescript
import VrlButton from '@public/components/common/buttons/VrlButton.vue';
import { useGtm } from '@public/composables/useGtm';
import { PhDownloadSimple } from '@phosphor-icons/vue';

const { trackEvent } = useGtm();

function exportToCSV(): void {
  // Build headers based on visible columns
  const headers: string[] = ['Position', 'Driver Name'];

  if (hasDivisions.value) {
    headers.push('Division');
  }

  // Add time columns with both absolute and gap
  headers.push('Qualifying Time', 'Qualifying Gap');
  headers.push('Race Time', 'Race Gap');
  headers.push('Fastest Lap', 'Fastest Lap Gap');

  // Build rows from sortedData
  const rows = sortedData.value.map((entry) => {
    const row: (string | number)[] = [
      entry.position,
      entry.driverName,
    ];

    if (hasDivisions.value) {
      row.push(entry.divisionName || '-');
    }

    row.push(entry.qualifyingTimeAbsolute);
    row.push(entry.qualifyingGap || '-');
    row.push(entry.raceTimeAbsolute);
    row.push(entry.raceGap || '-');
    row.push(entry.fastestLapAbsolute);
    row.push(entry.fastestLapGap || '-');

    return row;
  });

  // Convert to CSV format with proper escaping
  const csvContent = [
    headers.join(','),
    ...rows.map((row) =>
      row
        .map((cell) => {
          const cellStr = String(cell);
          if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
            return `"${cellStr.replace(/"/g, '""')}"`;
          }
          return cellStr;
        })
        .join(','),
    ),
  ].join('\n');

  // Create blob and trigger download
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);

  // Generate filename
  const sanitize = (str: string) => str.replace(/[^a-z0-9]/gi, '_').toLowerCase();
  const parts = [
    props.competitionName && sanitize(props.competitionName),
    props.seasonName && sanitize(props.seasonName),
    props.roundName && sanitize(props.roundName),
    'all_times',
  ].filter(Boolean);
  const filename = `${parts.join('_')}.csv`;

  link.setAttribute('href', url);
  link.setAttribute('download', filename);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);

  // Track CSV download event
  trackEvent('csv_download_click', {
    csv_filename: filename,
    league_name: props.competitionName,
    season_name: props.seasonName,
    table_type: 'cross_division_all_times',
  });
}
```

### Phase 4: Update Parent Component to Pass Props

**Files**: `resources/public/js/components/leagues/rounds/RoundAccordion.vue`

The `RoundAccordion.vue` component at line 119-126 uses `CrossDivisionAllTimesTable`. It already has access to:
- `props.competitionName` - passed from parent
- `props.seasonName` - passed from parent
- `roundTitle` computed property - derived from `props.round.name` or `Round ${props.round.round_number}`

**Current usage (line 119-126)**:
```vue
<CrossDivisionAllTimesTable
  :qualifying-results="roundData.qualifying_results"
  :race-time-results="roundData.race_time_results"
  :fastest-lap-results="roundData.fastest_lap_results"
  :race-events="raceEvents"
  :divisions="divisions"
/>
```

**Updated usage**:
```vue
<CrossDivisionAllTimesTable
  :qualifying-results="roundData.qualifying_results"
  :race-time-results="roundData.race_time_results"
  :fastest-lap-results="roundData.fastest_lap_results"
  :race-events="raceEvents"
  :divisions="divisions"
  :competition-name="props.competitionName"
  :season-name="props.seasonName"
  :round-name="roundTitle"
/>
```

### Phase 5: Add Unit Tests

**Files**: `resources/public/js/components/leagues/rounds/CrossDivisionAllTimesTable.test.ts`

**New test cases to add**:

```typescript
describe('CSV Export', () => {
  it('should render export button', () => {
    // Verify VrlButton with "Export Data" label exists
  });

  it('should call exportToCSV when button is clicked', async () => {
    // Click the export button and verify behavior
  });

  it('should generate correct CSV headers with divisions', () => {
    // Mock document methods, trigger export, verify headers
  });

  it('should generate correct CSV headers without divisions', () => {
    // Test with empty divisions array
  });

  it('should export correct data rows', () => {
    // Verify row data matches sortedData
  });

  it('should properly escape CSV special characters', () => {
    // Test with driver names containing commas/quotes
  });

  it('should generate correct filename from props', () => {
    // Test filename generation with various prop combinations
  });

  it('should track GTM event on export', () => {
    // Mock useGtm and verify trackEvent is called
  });

  it('should use sorted data (not raw data) for export', () => {
    // Change sort column, export, verify order matches displayed order
  });
});
```

## Agent Assignment

- **Agent**: `dev-fe-public`
- **Reasoning**: This is frontend Vue.js development in the `resources/public` directory

## Success Criteria

### Automated Verification
- [x] All existing tests pass: `.claude/support/scripts/vitests_run_tests.sh resources/public/js/components/leagues/rounds/CrossDivisionAllTimesTable.test.ts`
- [x] New CSV export tests pass
- [x] TypeScript compilation passes: `npm run type-check` (pre-existing vite.config.ts issues only)
- [x] ESLint passes: `npm run lint` (pre-existing warnings in unrelated files only)
- [x] Formatting passes: `npm run format`

### Manual Verification
- [ ] Export button appears in the UI above the table
- [ ] Clicking export downloads a CSV file
- [ ] CSV filename includes competition, season, and round names when provided
- [ ] CSV contains correct headers (including Division column only when divisions exist)
- [ ] CSV data matches the currently sorted view (respects sort column)
- [ ] Times display in same format as table (MM:SS.mmm)
- [ ] Gaps display correctly (with + prefix for non-leaders, - for nulls)
- [ ] GTM event fires on download (check browser dev tools)

## Technical Notes

1. **Sort State**: The CSV export uses `sortedData` which respects the current sort column selection. This means the exported order matches what the user sees.

2. **Division Column**: The division column is conditionally included based on `hasDivisions` computed property, same as in the table display.

3. **Time Format**: We export the same formatted strings shown in the UI (`qualifyingTimeAbsolute`, `raceTimeAbsolute`, etc.) rather than raw milliseconds, for user readability.

4. **Analytics**: Following the existing pattern, we track downloads with `csv_download_click` event including metadata about what was downloaded.

## File Changes Summary

| File | Action | Description |
|------|--------|-------------|
| `resources/public/js/components/leagues/rounds/CrossDivisionAllTimesTable.vue` | Modify | Add props, button, and export function |
| `resources/public/js/components/leagues/rounds/CrossDivisionAllTimesTable.test.ts` | Modify | Add CSV export test cases |
| Parent components (TBD) | Modify | Pass new props for filename generation |
