# Implementation Plan: Add Fastest Lap Time Display When Race Times Not Required

## Overview

The SeasonDetailWhiteLabelView.vue currently only displays the actual fastest lap **time** when `raceTimesRequired` is true (a season-level setting). When `raceTimesRequired` is false, only the "FL" badge is shown, but the actual lap time is hidden. This plan addresses adding fastest lap time display and export even when race times are not required.

## Problem Statement

**Current Behavior:**
- When `season.race_times_required = true`: Fastest lap TIME is shown in its own column alongside Time, Gap, Penalties
- When `season.race_times_required = false`: Only "FL" badge is shown, but the actual fastest lap time is NOT displayed

**Issue Location:**
- Template lines 552-574: Headers only include "Fastest Lap" column when `raceTimesRequired`
- Template lines 627-634: Fastest lap time cell only rendered when `raceTimesRequired`
- CSV export lines 2206-2211: Headers only include "Fastest Lap" time column when `hasRaceTimes`
- CSV export lines 2247-2248: Fastest lap time only added to row when `hasRaceTimes`

**User Expectation:**
If fastest lap data exists in race results (`result.fastest_lap` is not null), it should be visible regardless of the `raceTimesRequired` setting.

## Research Findings

### Data Flow Analysis

1. **Backend provides fastest lap data regardless of `raceTimesRequired`**:
   - `race_results.fastest_lap` - The actual lap time (string, e.g., "1:25.123")
   - `race_results.has_fastest_lap` - Boolean indicating if this was the fastest lap

2. **`raceTimesRequired` is a separate season setting** (line 1118):
   ```typescript
   const raceTimesRequired = computed<boolean>(() => {
     return seasonData.value?.season.race_times_required ?? false;
   });
   ```
   This controls whether race time, gap, and penalties are REQUIRED fields - not whether fastest lap should be hidden.

3. **The data IS available** - The issue is purely display/export logic.

### Files Affected

| File | Lines | Change Needed |
|------|-------|---------------|
| `resources/public/js/views/leagues/SeasonDetailWhiteLabelView.vue` | 550-575 | Add FL column header when not `raceTimesRequired` |
| `resources/public/js/views/leagues/SeasonDetailWhiteLabelView.vue` | 640-654 | Add FL time cell when not `raceTimesRequired` |
| `resources/public/js/views/leagues/SeasonDetailWhiteLabelView.vue` | 2206-2248 | Add FL time to CSV export when not `hasRaceTimes` |

## Implementation Approach

### Option A: Always Show Fastest Lap Time Column (Recommended)

Add the fastest lap time column to the race results table regardless of `raceTimesRequired`. The column would appear after the basic "Time" column when `raceTimesRequired` is false.

**Pros:**
- Consistent display of available data
- Users can always see fastest lap times if they exist
- Minimal template changes

**Cons:**
- Slightly wider table

### Option B: Only Show FL Time When Data Exists

Dynamically show the fastest lap time column only when at least one result has a non-null `fastest_lap` value.

**Pros:**
- Cleaner table when no FL data exists

**Cons:**
- More complex logic
- Inconsistent column count between races

**Decision: Option A** - Always show the fastest lap time column, displaying "-" if no data exists.

## Implementation Steps

### Phase 1: Update Race Results Table Template (Non-RaceTimesRequired Mode)

**Current template structure (lines 564-575):**
```html
<!-- Basic time display (no times required) -->
<template v-else>
  <th class="th-time">Time</th>
</template>
<!-- Positions gained (races only) -->
<th v-if="!raceEvent.is_qualifier" class="th-plusminus">+/-</th>
<!-- Points (if enabled) -->
<th v-if="raceEvent.race_points" class="th-pts">Pts</th>
<!-- Fastest lap badge (only if not showing FL time column) -->
<th v-if="!raceTimesRequired && !raceEvent.is_qualifier" class="th-fl">
  FL
</th>
```

**Updated structure:**
```html
<!-- Basic time display (no times required) -->
<template v-else>
  <th class="th-time">Time</th>
  <!-- Add Fastest Lap time column for races (not qualifiers) -->
  <th v-if="!raceEvent.is_qualifier" class="th-fl-time">Fastest Lap</th>
</template>
```

**Remove the FL badge column** (line 572-574) since we're now showing the actual time.

### Phase 2: Update Race Results Table Body (Non-RaceTimesRequired Mode)

**Current body structure (lines 646-654):**
```html
<!-- Basic time display -->
<template v-else>
  <td class="td-time">
    {{ result.position === 1 ? result.final_race_time : result.final_race_time_difference || '-' }}
  </td>
</template>
```

**Updated structure:**
```html
<!-- Basic time display -->
<template v-else>
  <td class="td-time">
    {{ result.position === 1 ? result.final_race_time : result.final_race_time_difference || '-' }}
  </td>
  <!-- Fastest Lap time for races (not qualifiers) -->
  <td v-if="!raceEvent.is_qualifier" class="td-fl-time" :class="{ 'has-fastest': result.has_fastest_lap }">
    {{ formatRaceTime(result.fastest_lap) || '-' }}
  </td>
</template>
```

**Remove the FL badge cell** (line 666-668) since we're now showing the actual time.

### Phase 3: Update CSV Export for Race Events

**Current export logic (lines 2206-2211):**
```typescript
if (!isQualifier && hasRaceTimes) {
  headers.push('Time', 'Gap');
}

if (hasRaceTimes) {
  headers.push(isQualifier ? 'Lap Time' : 'Fastest Lap');
}
```

**Updated logic:**
```typescript
if (!isQualifier && hasRaceTimes) {
  headers.push('Time', 'Gap');
}

if (hasRaceTimes) {
  headers.push(isQualifier ? 'Lap Time' : 'Fastest Lap');
} else if (!isQualifier) {
  // Add Fastest Lap column even when race times not required
  headers.push('Fastest Lap');
}
```

**Current row building (lines 2246-2248):**
```typescript
if (hasRaceTimes) {
  row.push(formatRaceTime(result.fastest_lap) || '');
}
```

**Updated logic:**
```typescript
if (hasRaceTimes) {
  row.push(formatRaceTime(result.fastest_lap) || '');
} else if (!isQualifier) {
  // Add Fastest Lap time even when race times not required
  row.push(formatRaceTime(result.fastest_lap) || '');
}
```

## Agent Assignment

**Agent**: `dev-fe-public`

This task involves only frontend changes to the public site Vue component.

## Detailed Changes

### File: `resources/public/js/views/leagues/SeasonDetailWhiteLabelView.vue`

#### Change 1: Update Table Headers (around line 564-575)

**Old:**
```html
<!-- Basic time display (no times required) -->
<template v-else>
  <th class="th-time">Time</th>
</template>
<!-- Positions gained (races only) -->
<th v-if="!raceEvent.is_qualifier" class="th-plusminus">+/-</th>
<!-- Points (if enabled) -->
<th v-if="raceEvent.race_points" class="th-pts">Pts</th>
<!-- Fastest lap badge (only if not showing FL time column) -->
<th v-if="!raceTimesRequired && !raceEvent.is_qualifier" class="th-fl">
  FL
</th>
```

**New:**
```html
<!-- Basic time display (no times required) -->
<template v-else>
  <th class="th-time">Time</th>
  <!-- Fastest Lap time column for races (not qualifiers) -->
  <th v-if="!raceEvent.is_qualifier" class="th-fl-time">Fastest Lap</th>
</template>
<!-- Positions gained (races only) -->
<th v-if="!raceEvent.is_qualifier" class="th-plusminus">+/-</th>
<!-- Points (if enabled) -->
<th v-if="raceEvent.race_points" class="th-pts">Pts</th>
```

#### Change 2: Update Table Body (around line 646-668)

**Old:**
```html
<!-- Basic time display -->
<template v-else>
  <td class="td-time">
    {{
      result.position === 1
        ? result.final_race_time
        : result.final_race_time_difference || '-'
    }}
  </td>
</template>
<!-- Positions gained -->
<td v-if="!raceEvent.is_qualifier" class="td-plusminus">
  ...
</td>
<!-- Points -->
<td v-if="raceEvent.race_points" class="td-pts">
  {{ result.race_points }}
</td>
<!-- Fastest lap badge (basic mode only) -->
<td v-if="!raceTimesRequired && !raceEvent.is_qualifier" class="td-fl">
  <span v-if="result.has_fastest_lap" class="badge badge-fl">FL</span>
</td>
```

**New:**
```html
<!-- Basic time display -->
<template v-else>
  <td class="td-time">
    {{
      result.position === 1
        ? result.final_race_time
        : result.final_race_time_difference || '-'
    }}
  </td>
  <!-- Fastest Lap time for races (not qualifiers) -->
  <td
    v-if="!raceEvent.is_qualifier"
    class="td-fl-time"
    :class="{ 'has-fastest': result.has_fastest_lap }"
  >
    {{ formatRaceTime(result.fastest_lap) || '-' }}
  </td>
</template>
<!-- Positions gained -->
<td v-if="!raceEvent.is_qualifier" class="td-plusminus">
  ...
</td>
<!-- Points -->
<td v-if="raceEvent.race_points" class="td-pts">
  {{ result.race_points }}
</td>
```

#### Change 3: Update CSV Export Headers (around line 2206-2234)

Add fastest lap column when `!hasRaceTimes && !isQualifier`:

```typescript
// After line 2211
} else if (!isQualifier) {
  // Add Fastest Lap column even when race times not required
  headers.push('Fastest Lap');
}
```

#### Change 4: Update CSV Export Rows (around line 2247-2271)

Add fastest lap time when `!hasRaceTimes && !isQualifier`:

```typescript
// After line 2248
} else if (!isQualifier) {
  // Add Fastest Lap time even when race times not required
  row.push(formatRaceTime(result.fastest_lap) || '');
}
```

## Success Criteria

### Automated Verification:
- [x] All Vitest tests pass: `.claude/support/scripts/vitests_run_tests.sh`
- [x] No linting errors: `npm run lint`
- [ ] TypeScript compilation passes: `npm run type-check` (pre-existing vite.config.ts issues)
- [x] ESLint passes: `npm run lint:fix`
- [x] Formatting passes: `npm run format`

### Manual Verification:
- [ ] When `race_times_required = false`:
  - [ ] Race results table shows "Fastest Lap" column header
  - [ ] Each result row shows the fastest lap time (or "-" if null)
  - [ ] The fastest lap time is highlighted (has-fastest class) for the driver with `has_fastest_lap = true`
- [ ] CSV export includes "Fastest Lap" column with times when `race_times_required = false`
- [ ] Existing behavior unchanged when `race_times_required = true`
- [ ] Qualifying sessions still don't show fastest lap column (they show "Lap Time" instead)

## Out of Scope

- Adding fastest lap time to the season-level standings table (it only shows the FL badge per round)
- Changing the "All Times" tab behavior
- Modifying backend data structures

## Dependencies

None - this is a frontend-only change using existing data.

## Risks

**Low Risk**:
- The data already exists in the API response
- Changes are additive (showing more data)
- Existing logic for `raceTimesRequired = true` is unchanged

## Testing Approach

1. Run existing Vitest tests to ensure no regressions
2. Manually test with a season where `race_times_required = false` and verify:
   - Fastest lap times appear in race results
   - CSV export includes fastest lap times
3. Verify `race_times_required = true` behavior is unchanged

## Rollback Plan

Revert the changes to `SeasonDetailWhiteLabelView.vue` if issues are discovered.
