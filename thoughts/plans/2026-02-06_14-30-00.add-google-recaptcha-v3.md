# Implementation Plan: Add Google reCAPTCHA v3 to Login and Registration Forms

## Overview

Add Google reCAPTCHA v3 protection to the admin login, public login, and public registration forms to prevent automated bot attacks while maintaining a seamless user experience (no user interaction required).

## Scope

### In Scope
- Admin login form (`admin.virtualracingleagues.localhost/login`)
- Public login form (`virtualracingleagues.localhost/login`)
- Public registration form (`virtualracingleagues.localhost/register`)
- Backend validation using Laravel package
- Frontend integration with Vue 3 composable
- Environment-based configuration (optional in development)
- Test mocking support

### Out of Scope
- Forgot password form
- Contact form
- Any other forms
- reCAPTCHA Enterprise features
- Custom analytics/reporting dashboard

## Technical Approach

### Backend: Laravel Package
Use `josiasmontag/laravel-recaptchav3` package which provides:
- Validation rule: `recaptchav3:action_name,min_score`
- Facade for manual verification
- Test mocking support

### Frontend: Vue 3 Composable
Create a shared composable `useRecaptcha()` that:
- Loads the reCAPTCHA v3 script dynamically
- Provides `executeRecaptcha(action)` method
- Returns the token for form submission
- Handles errors gracefully

### Actions (for score tracking in Google Console)
- `login` - Public site login
- `admin_login` - Admin dashboard login
- `register` - Public site registration

### Score Threshold
- Default: 0.5 (configurable via environment)
- Scores 0.0-1.0 where 1.0 is very likely a good interaction

---

## Phase 1: Backend Setup

**Agent**: `dev-be`

### 1.1 Install Laravel Package

```bash
composer require josiasmontag/laravel-recaptchav3
```

### 1.2 Publish Configuration

```bash
php artisan vendor:publish --provider="Lunaweb\RecaptchaV3\Providers\RecaptchaV3ServiceProvider"
```

### 1.3 Add Environment Variables

**File**: `.env.example`

Add at the end:
```env
# Google reCAPTCHA v3
RECAPTCHAV3_SITEKEY=
RECAPTCHAV3_SECRET=
RECAPTCHAV3_LOCALE=en
RECAPTCHAV3_ENABLED=true
RECAPTCHAV3_MIN_SCORE=0.5
```

**File**: `.env` (manual step - user must add their keys)

### 1.4 Update Configuration

**File**: `config/recaptchav3.php` (created by publish command)

Modify to add enabled flag and min_score:
```php
<?php

return [
    'origin' => env('RECAPTCHAV3_ORIGIN', 'https://www.google.com/recaptcha'),
    'sitekey' => env('RECAPTCHAV3_SITEKEY', ''),
    'secret' => env('RECAPTCHAV3_SECRET', ''),
    'locale' => env('RECAPTCHAV3_LOCALE', 'en'),

    // Custom additions
    'enabled' => env('RECAPTCHAV3_ENABLED', true),
    'min_score' => env('RECAPTCHAV3_MIN_SCORE', 0.5),
];
```

### 1.5 Create Custom Validation Rule

**File**: `app/Rules/RecaptchaV3Rule.php`

```php
<?php

declare(strict_types=1);

namespace App\Rules;

use Closure;
use Illuminate\Contracts\Validation\ValidationRule;
use Lunaweb\RecaptchaV3\Facades\RecaptchaV3;

/**
 * Validates Google reCAPTCHA v3 token.
 *
 * Can be disabled via RECAPTCHAV3_ENABLED=false for development.
 */
class RecaptchaV3Rule implements ValidationRule
{
    public function __construct(
        private readonly string $action,
        private readonly ?float $minScore = null
    ) {
    }

    public function validate(string $attribute, mixed $value, Closure $fail): void
    {
        // Skip validation if reCAPTCHA is disabled
        if (!config('recaptchav3.enabled', true)) {
            return;
        }

        // Skip if no token provided (will be caught by 'required' rule if needed)
        if (empty($value)) {
            $fail('The reCAPTCHA verification is required.');
            return;
        }

        $minScore = $this->minScore ?? config('recaptchav3.min_score', 0.5);

        try {
            $score = RecaptchaV3::verify($value, $this->action);

            if ($score === false || $score < $minScore) {
                $fail('The reCAPTCHA verification failed. Please try again.');
            }
        } catch (\Exception $e) {
            // Log the error but don't expose details to user
            \Log::warning('reCAPTCHA verification failed', [
                'action' => $this->action,
                'error' => $e->getMessage(),
            ]);
            $fail('The reCAPTCHA verification failed. Please try again.');
        }
    }
}
```

### 1.6 Update Login Request (Public)

**File**: `app/Http/Requests/Auth/LoginRequest.php`

```php
<?php

declare(strict_types=1);

namespace App\Http\Requests\Auth;

use App\Rules\RecaptchaV3Rule;
use Illuminate\Foundation\Http\FormRequest;

class LoginRequest extends FormRequest
{
    public function authorize(): bool
    {
        return true;
    }

    /**
     * @return array<string, array<int, mixed>>
     */
    public function rules(): array
    {
        $rules = [
            'email' => ['required', 'string', 'email'],
            'password' => ['required', 'string'],
            'remember' => ['boolean'],
        ];

        // Add reCAPTCHA validation if enabled
        if (config('recaptchav3.enabled', true)) {
            $rules['recaptcha_token'] = ['required', new RecaptchaV3Rule('login')];
        }

        return $rules;
    }

    /**
     * @return array<string, string>
     */
    public function messages(): array
    {
        return [
            'email.required' => 'Email address is required',
            'email.email' => 'Please provide a valid email address',
            'password.required' => 'Password is required',
            'recaptcha_token.required' => 'Please complete the security verification',
        ];
    }
}
```

### 1.7 Update Register Request

**File**: `app/Http/Requests/Auth/RegisterRequest.php`

```php
<?php

declare(strict_types=1);

namespace App\Http\Requests\Auth;

use App\Rules\RecaptchaV3Rule;
use Illuminate\Foundation\Http\FormRequest;

class RegisterRequest extends FormRequest
{
    public function authorize(): bool
    {
        return true;
    }

    /**
     * @return array<string, array<int, mixed>>
     */
    public function rules(): array
    {
        $rules = [
            'first_name' => ['required', 'string', 'max:255'],
            'last_name' => ['required', 'string', 'max:255'],
            'email' => ['required', 'string', 'email', 'max:255', 'unique:users,email'],
            'password' => ['required', 'string', 'min:8', 'confirmed'],
        ];

        // Add reCAPTCHA validation if enabled
        if (config('recaptchav3.enabled', true)) {
            $rules['recaptcha_token'] = ['required', new RecaptchaV3Rule('register')];
        }

        return $rules;
    }

    /**
     * @return array<string, string>
     */
    public function messages(): array
    {
        return [
            'first_name.required' => 'First name is required',
            'last_name.required' => 'Last name is required',
            'email.required' => 'Email address is required',
            'email.email' => 'Please provide a valid email address',
            'email.unique' => 'This email address is already registered',
            'password.required' => 'Password is required',
            'password.min' => 'Password must be at least 8 characters',
            'password.confirmed' => 'Password confirmation does not match',
            'recaptcha_token.required' => 'Please complete the security verification',
        ];
    }
}
```

### 1.8 Update Admin Auth Controller

**File**: `app/Http/Controllers/Admin/AdminAuthController.php`

Update the `login` method to include reCAPTCHA validation:

```php
public function login(Request $request): JsonResponse
{
    $rules = [
        'email' => ['required', 'email'],
        'password' => ['required', 'string'],
        'remember' => ['boolean'],
    ];

    // Add reCAPTCHA validation if enabled
    if (config('recaptchav3.enabled', true)) {
        $rules['recaptcha_token'] = ['required', new \App\Rules\RecaptchaV3Rule('admin_login')];
    }

    $validated = $request->validate($rules);

    // ... rest of method unchanged
}
```

### 1.9 Add API Endpoint for reCAPTCHA Config

Create a simple endpoint to expose the site key to frontend (public information).

**File**: `app/Http/Controllers/RecaptchaConfigController.php`

```php
<?php

declare(strict_types=1);

namespace App\Http\Controllers;

use App\Helpers\ApiResponse;
use Illuminate\Http\JsonResponse;

class RecaptchaConfigController extends Controller
{
    public function show(): JsonResponse
    {
        return ApiResponse::success([
            'enabled' => config('recaptchav3.enabled', true),
            'siteKey' => config('recaptchav3.enabled', true)
                ? config('recaptchav3.sitekey', '')
                : null,
        ]);
    }
}
```

### 1.10 Add Routes

**File**: `routes/subdomain.php`

Add to public routes (around line 374, before the auth routes):
```php
// reCAPTCHA config (public)
Route::get('/recaptcha-config', [RecaptchaConfigController::class, 'show'])
    ->name('recaptcha-config');
```

**File**: `routes/admin-api.php`

Add after the CSRF cookie route (around line 33):
```php
// reCAPTCHA config (public)
Route::get('/recaptcha-config', [\App\Http\Controllers\RecaptchaConfigController::class, 'show'])
    ->name('recaptcha-config');
```

### 1.11 Update Test Environment

**File**: `.env.testing`

Add:
```env
RECAPTCHAV3_ENABLED=false
```

This disables reCAPTCHA in tests by default.

---

## Phase 2: Frontend - Public Site

**Agent**: `dev-fe-public`

### 2.1 Create reCAPTCHA Composable

**File**: `resources/public/js/composables/useRecaptcha.ts`

```typescript
import { ref, onMounted } from 'vue';
import { api } from '@public/services/api';

interface RecaptchaConfig {
  enabled: boolean;
  siteKey: string | null;
}

declare global {
  interface Window {
    grecaptcha: {
      ready: (callback: () => void) => void;
      execute: (siteKey: string, options: { action: string }) => Promise<string>;
    };
  }
}

const isLoaded = ref(false);
const isLoading = ref(false);
const config = ref<RecaptchaConfig | null>(null);
const configLoaded = ref(false);

/**
 * Composable for Google reCAPTCHA v3 integration.
 * Handles script loading, token generation, and configuration.
 */
export function useRecaptcha() {
  const error = ref<string | null>(null);

  /**
   * Fetch reCAPTCHA configuration from backend
   */
  const fetchConfig = async (): Promise<RecaptchaConfig | null> => {
    if (configLoaded.value) {
      return config.value;
    }

    try {
      const response = await api.get<{ data: RecaptchaConfig }>('/api/recaptcha-config');
      config.value = response.data.data;
      configLoaded.value = true;
      return config.value;
    } catch (e) {
      console.warn('Failed to fetch reCAPTCHA config, assuming disabled');
      config.value = { enabled: false, siteKey: null };
      configLoaded.value = true;
      return config.value;
    }
  };

  /**
   * Load the reCAPTCHA v3 script
   */
  const loadScript = async (): Promise<void> => {
    if (isLoaded.value || isLoading.value) return;

    const cfg = await fetchConfig();
    if (!cfg?.enabled || !cfg?.siteKey) {
      return;
    }

    isLoading.value = true;

    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = `https://www.google.com/recaptcha/api.js?render=${cfg.siteKey}`;
      script.async = true;
      script.defer = true;

      script.onload = () => {
        isLoaded.value = true;
        isLoading.value = false;
        resolve();
      };

      script.onerror = () => {
        isLoading.value = false;
        error.value = 'Failed to load reCAPTCHA';
        reject(new Error('Failed to load reCAPTCHA script'));
      };

      document.head.appendChild(script);
    });
  };

  /**
   * Execute reCAPTCHA and get a token
   * @param action - The action name (e.g., 'login', 'register')
   * @returns The reCAPTCHA token or null if disabled/failed
   */
  const executeRecaptcha = async (action: string): Promise<string | null> => {
    error.value = null;

    const cfg = await fetchConfig();
    if (!cfg?.enabled || !cfg?.siteKey) {
      return null;
    }

    try {
      await loadScript();

      return new Promise((resolve, reject) => {
        window.grecaptcha.ready(() => {
          window.grecaptcha
            .execute(cfg.siteKey!, { action })
            .then((token) => {
              resolve(token);
            })
            .catch((err) => {
              error.value = 'reCAPTCHA verification failed';
              reject(err);
            });
        });
      });
    } catch (e) {
      error.value = 'reCAPTCHA verification failed';
      return null;
    }
  };

  /**
   * Check if reCAPTCHA is enabled
   */
  const isEnabled = async (): Promise<boolean> => {
    const cfg = await fetchConfig();
    return cfg?.enabled ?? false;
  };

  return {
    executeRecaptcha,
    isEnabled,
    loadScript,
    error,
    isLoaded,
    isLoading,
  };
}
```

### 2.2 Create reCAPTCHA Service

**File**: `resources/public/js/services/recaptchaService.ts`

```typescript
import { api } from '@public/services/api';

export interface RecaptchaConfig {
  enabled: boolean;
  siteKey: string | null;
}

export const recaptchaService = {
  async getConfig(): Promise<RecaptchaConfig> {
    const response = await api.get<{ data: RecaptchaConfig }>('/api/recaptcha-config');
    return response.data.data;
  },
};
```

### 2.3 Update Public Login View

**File**: `resources/public/js/views/auth/LoginView.vue`

Update the script section:

```typescript
<script setup lang="ts">
import { ref, computed, onMounted } from 'vue';
import { useAuthStore } from '@public/stores/authStore';
import { isAxiosError, hasValidationErrors, getErrorMessage } from '@public/types/errors';
import { useRecaptcha } from '@public/composables/useRecaptcha';
// ... other imports

const authStore = useAuthStore();
const { executeRecaptcha, loadScript, error: recaptchaError } = useRecaptcha();

// ... existing refs

const handleSubmit = async (): Promise<void> => {
  errorMessage.value = '';
  emailError.value = '';
  passwordError.value = '';

  const isEmailValid = validateEmail();
  const isPasswordValid = validatePassword();

  if (!isEmailValid || !isPasswordValid) {
    return;
  }

  isSubmitting.value = true;

  try {
    // Get reCAPTCHA token
    const recaptchaToken = await executeRecaptcha('login');

    await authStore.login({
      email: email.value.trim(),
      password: password.value,
      remember: remember.value,
      recaptcha_token: recaptchaToken,
    });

    // Note: authStore.login() will redirect to app subdomain automatically
  } catch (error: unknown) {
    if (isAxiosError(error)) {
      if (hasValidationErrors(error)) {
        const validationErrors = error.response?.data?.errors;
        if (validationErrors?.recaptcha_token) {
          errorMessage.value = 'Security verification failed. Please try again.';
        } else {
          errorMessage.value = 'Invalid email or password. Please try again.';
        }
      } else if (error.response?.status === 401) {
        errorMessage.value = 'Invalid email or password. Please try again.';
      } else if (error.response?.status === 429) {
        errorMessage.value = 'Too many login attempts. Please wait a moment and try again.';
      } else if (error.response?.status && error.response.status >= 500) {
        errorMessage.value = 'Server error. Please try again later.';
      } else {
        errorMessage.value = 'Login failed. Please try again.';
      }
    } else {
      errorMessage.value = getErrorMessage(error, 'Login failed. Please try again.');
    }
  } finally {
    isSubmitting.value = false;
  }
};

// Preload reCAPTCHA script on mount
onMounted(() => {
  loadScript();
});
</script>
```

### 2.4 Update Auth Store

**File**: `resources/public/js/stores/authStore.ts`

Update the login method signature to accept `recaptcha_token`:

```typescript
interface LoginCredentials {
  email: string;
  password: string;
  remember?: boolean;
  recaptcha_token?: string | null;
}
```

### 2.5 Update Auth Service

**File**: `resources/public/js/services/authService.ts`

Update the login method to pass `recaptcha_token`:

```typescript
interface LoginData {
  email: string;
  password: string;
  remember?: boolean;
  recaptcha_token?: string | null;
}

async login(data: LoginData): Promise<AuthResponse> {
  const response = await api.post<AuthResponse>('/api/login', data);
  return response.data;
}
```

### 2.6 Update Public Register View

**File**: `resources/public/js/views/auth/RegisterView.vue`

Similar updates to LoginView:

```typescript
<script setup lang="ts">
import { ref, computed, onMounted } from 'vue';
// ... existing imports
import { useRecaptcha } from '@public/composables/useRecaptcha';

// ... existing code

const { executeRecaptcha, loadScript } = useRecaptcha();

const handleSubmit = async (): Promise<void> => {
  // ... existing validation

  isSubmitting.value = true;

  try {
    // Get reCAPTCHA token
    const recaptchaToken = await executeRecaptcha('register');

    const userEmail = await authStore.register({
      first_name: firstName.value.trim(),
      last_name: lastName.value.trim(),
      email: email.value.trim(),
      password: password.value,
      password_confirmation: passwordConfirmation.value,
      recaptcha_token: recaptchaToken,
    });

    // ... rest of success handling
  } catch (error: unknown) {
    if (isAxiosError(error)) {
      if (hasValidationErrors(error)) {
        const validationErrors = error.response?.data?.errors;
        if (validationErrors?.recaptcha_token) {
          errorMessage.value = 'Security verification failed. Please try again.';
          return;
        }
        // ... rest of error handling
      }
      // ... rest of error handling
    }
    // ... rest of error handling
  } finally {
    isSubmitting.value = false;
  }
};

onMounted(() => {
  fetchSiteConfig();
  loadScript(); // Preload reCAPTCHA
});
</script>
```

### 2.7 Update Register Types/Store

Update the register method in authStore to accept `recaptcha_token`.

---

## Phase 3: Frontend - Admin Dashboard

**Agent**: `dev-fe-admin`

### 3.1 Create reCAPTCHA Composable (Admin)

**File**: `resources/admin/js/composables/useRecaptcha.ts`

Same implementation as public, but using admin API path:

```typescript
// Same as public version but with:
const response = await api.get<{ data: RecaptchaConfig }>('/api/recaptcha-config');
```

### 3.2 Update Admin Login View

**File**: `resources/admin/js/views/AdminLoginView.vue`

```typescript
<script setup lang="ts">
import { ref, computed, onMounted } from 'vue';
import { useRouter } from 'vue-router';
import { useAdminStore } from '@admin/stores/adminStore';
import { useRecaptcha } from '@admin/composables/useRecaptcha';
// ... other imports

const { executeRecaptcha, loadScript } = useRecaptcha();

// ... existing code

const handleSubmit = async (): Promise<void> => {
  // ... existing validation

  isSubmitting.value = true;

  try {
    // Get reCAPTCHA token
    const recaptchaToken = await executeRecaptcha('admin_login');

    await adminStore.login({
      email: email.value.trim(),
      password: password.value,
      remember: remember.value,
      recaptcha_token: recaptchaToken,
    });

    await router.replace({ name: 'dashboard' });
  } catch (error: unknown) {
    if (isAxiosError(error)) {
      if (hasValidationErrors(error)) {
        const validationErrors = error.response?.data?.errors;
        if (validationErrors?.recaptcha_token) {
          errorMessage.value = 'Security verification failed. Please try again.';
        } else {
          // ... existing error handling
        }
      }
      // ... rest of error handling
    }
    // ... rest of error handling
  } finally {
    isSubmitting.value = false;
  }
};

onMounted(() => {
  loadScript();
});
</script>
```

### 3.3 Update Admin Store

**File**: `resources/admin/js/stores/adminStore.ts`

Update login method to accept `recaptcha_token`.

### 3.4 Update Admin Auth Service

**File**: `resources/admin/js/services/authService.ts`

Update login method to pass `recaptcha_token`.

---

## Phase 4: Testing

**Agent**: `dev-be` for backend, `dev-fe-public` and `dev-fe-admin` for frontend

### 4.1 Backend Unit Test for RecaptchaV3Rule

**File**: `tests/Unit/Rules/RecaptchaV3RuleTest.php`

```php
<?php

declare(strict_types=1);

namespace Tests\Unit\Rules;

use App\Rules\RecaptchaV3Rule;
use Illuminate\Support\Facades\Config;
use Lunaweb\RecaptchaV3\Facades\RecaptchaV3;
use Tests\TestCase;

class RecaptchaV3RuleTest extends TestCase
{
    public function test_passes_when_recaptcha_disabled(): void
    {
        Config::set('recaptchav3.enabled', false);

        $rule = new RecaptchaV3Rule('login');
        $failed = false;

        $rule->validate('recaptcha_token', 'any-token', function () use (&$failed) {
            $failed = true;
        });

        $this->assertFalse($failed);
    }

    public function test_fails_when_token_empty(): void
    {
        Config::set('recaptchav3.enabled', true);

        $rule = new RecaptchaV3Rule('login');
        $failed = false;

        $rule->validate('recaptcha_token', '', function () use (&$failed) {
            $failed = true;
        });

        $this->assertTrue($failed);
    }

    public function test_passes_when_score_above_threshold(): void
    {
        Config::set('recaptchav3.enabled', true);
        Config::set('recaptchav3.min_score', 0.5);

        RecaptchaV3::shouldReceive('verify')
            ->once()
            ->with('valid-token', 'login')
            ->andReturn(0.9);

        $rule = new RecaptchaV3Rule('login');
        $failed = false;

        $rule->validate('recaptcha_token', 'valid-token', function () use (&$failed) {
            $failed = true;
        });

        $this->assertFalse($failed);
    }

    public function test_fails_when_score_below_threshold(): void
    {
        Config::set('recaptchav3.enabled', true);
        Config::set('recaptchav3.min_score', 0.5);

        RecaptchaV3::shouldReceive('verify')
            ->once()
            ->with('bot-token', 'login')
            ->andReturn(0.1);

        $rule = new RecaptchaV3Rule('login');
        $failed = false;

        $rule->validate('recaptcha_token', 'bot-token', function () use (&$failed) {
            $failed = true;
        });

        $this->assertTrue($failed);
    }
}
```

### 4.2 Backend Feature Test Updates

Update existing login/register tests to:
1. Set `RECAPTCHAV3_ENABLED=false` in test setup (already in `.env.testing`)
2. Or mock the RecaptchaV3 facade when testing with reCAPTCHA enabled

### 4.3 Frontend Unit Tests

**File**: `resources/public/js/composables/useRecaptcha.test.ts`

```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { useRecaptcha } from './useRecaptcha';

// Mock the api module
vi.mock('@public/services/api', () => ({
  api: {
    get: vi.fn(),
  },
}));

describe('useRecaptcha', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  it('returns null token when reCAPTCHA is disabled', async () => {
    const { api } = await import('@public/services/api');
    vi.mocked(api.get).mockResolvedValue({
      data: { data: { enabled: false, siteKey: null } },
    });

    const { executeRecaptcha } = useRecaptcha();
    const token = await executeRecaptcha('login');

    expect(token).toBeNull();
  });

  // Additional tests...
});
```

---

## Phase 5: Documentation

**Agent**: `dev-be`

### 5.1 Update .env.example

Already covered in Phase 1.3.

### 5.2 Add Setup Instructions to README (if needed)

Add a section about obtaining reCAPTCHA keys from Google Console:
1. Go to https://www.google.com/recaptcha/admin
2. Register a new site with reCAPTCHA v3
3. Add domains: `virtualracingleagues.localhost`, `localhost` (for development)
4. Copy Site Key to `RECAPTCHAV3_SITEKEY`
5. Copy Secret Key to `RECAPTCHAV3_SECRET`

---

## Files to Create

| File | Description |
|------|-------------|
| `config/recaptchav3.php` | Published config (via artisan) |
| `app/Rules/RecaptchaV3Rule.php` | Custom validation rule |
| `app/Http/Controllers/RecaptchaConfigController.php` | API endpoint for frontend config |
| `resources/public/js/composables/useRecaptcha.ts` | Public site composable |
| `resources/public/js/services/recaptchaService.ts` | Public site service |
| `resources/admin/js/composables/useRecaptcha.ts` | Admin dashboard composable |
| `tests/Unit/Rules/RecaptchaV3RuleTest.php` | Backend unit tests |
| `resources/public/js/composables/useRecaptcha.test.ts` | Frontend unit tests |
| `resources/admin/js/composables/useRecaptcha.test.ts` | Admin frontend tests |

## Files to Modify

| File | Changes |
|------|---------|
| `.env.example` | Add reCAPTCHA environment variables |
| `.env.testing` | Disable reCAPTCHA for tests |
| `app/Http/Requests/Auth/LoginRequest.php` | Add reCAPTCHA validation |
| `app/Http/Requests/Auth/RegisterRequest.php` | Add reCAPTCHA validation |
| `app/Http/Controllers/Admin/AdminAuthController.php` | Add reCAPTCHA validation to login |
| `routes/subdomain.php` | Add recaptcha-config route |
| `routes/admin-api.php` | Add recaptcha-config route |
| `resources/public/js/views/auth/LoginView.vue` | Integrate reCAPTCHA |
| `resources/public/js/views/auth/RegisterView.vue` | Integrate reCAPTCHA |
| `resources/public/js/stores/authStore.ts` | Update login/register methods |
| `resources/public/js/services/authService.ts` | Update login/register methods |
| `resources/admin/js/views/AdminLoginView.vue` | Integrate reCAPTCHA |
| `resources/admin/js/stores/adminStore.ts` | Update login method |
| `resources/admin/js/services/authService.ts` | Update login method |

---

## Success Criteria

### Automated Verification
- [x] All PHP tests pass: `.claude/support/scripts/phpunit_run_tests.sh`
- [x] All Vitest tests pass: `.claude/support/scripts/vitests_run_tests.sh`
- [x] No PHP linting errors: `composer run phpcs`
- [x] PHP static analysis passes: `composer run phpstan`
- [x] TypeScript builds without errors: `npm run type-check` (pre-existing vite.config.ts issue)
- [x] JavaScript/TypeScript ESLint passes: `npm run lint`
- [x] Code formatting passes: `npm run format`

### Manual Verification
- [ ] Admin login works with reCAPTCHA enabled (with valid keys)
- [ ] Admin login shows appropriate error for reCAPTCHA failure
- [ ] Public login works with reCAPTCHA enabled
- [ ] Public login shows appropriate error for reCAPTCHA failure
- [ ] Public registration works with reCAPTCHA enabled
- [ ] Public registration shows appropriate error for reCAPTCHA failure
- [ ] All forms work normally when `RECAPTCHAV3_ENABLED=false`
- [ ] reCAPTCHA badge appears on login/register pages (or is hidden with CSS)
- [ ] No console errors related to reCAPTCHA
- [ ] Google reCAPTCHA admin console shows requests with actions

---

## Rollback Plan

1. Set `RECAPTCHAV3_ENABLED=false` in `.env` to immediately disable reCAPTCHA
2. If complete removal needed:
   - Remove the validation rules from request classes
   - Remove the `recaptcha_token` field handling from controllers
   - Frontend will continue sending tokens but they'll be ignored

---

## Security Considerations

1. **Secret Key**: Never expose `RECAPTCHAV3_SECRET` to frontend
2. **Site Key**: Safe to expose (public by design)
3. **Score Threshold**: 0.5 is Google's recommended starting point; adjust based on actual traffic patterns
4. **Logging**: Log failed verifications for monitoring but don't expose details to users
5. **Graceful Degradation**: If reCAPTCHA service is unavailable, the site should still function (with disabled reCAPTCHA)

---

## Future Enhancements (Out of Scope)

- Add reCAPTCHA to password reset form
- Add reCAPTCHA to contact form
- Implement progressive security (lower scores trigger email verification)
- Dashboard for viewing reCAPTCHA analytics
- Rate limiting based on reCAPTCHA score
