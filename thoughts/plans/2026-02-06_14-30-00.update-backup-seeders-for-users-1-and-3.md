# Implementation Plan: Update Backup Seeders for Users 1 and 3

**Date:** 2026-02-06
**Agent:** `dev-be`

---

## Overview

Update the `generate_backup_seeders.php` script to export all data for users 1 and 3, including the full entity hierarchy: users, leagues, drivers, league_drivers, competitions, seasons, teams, divisions, season_drivers, rounds, races, and race_results.

---

## Current State

### Existing Backup System
- Located at: `/var/www/generate_backup_seeders.php`
- Output: `database/seeders/Backup/*.php`
- Currently exports: seasons, teams, divisions, season_drivers, rounds, races, race_results
- **Missing**: users, leagues, league_drivers (raw drivers), competitions

### Data Summary for Users 1 and 3

| Table | Count | Notes |
|-------|-------|-------|
| users | 2 | Users 1 (Samuel Goodwin) and 3 (Sammy Gman) |
| leagues | 2 | Race on Oz (user 1), North Coast GT4 League (user 3) |
| competitions | 2 | Sunday Nights, Trash Tuesday GT4 |
| drivers | 112 | All drivers in system |
| league_drivers | 110 | Drivers linked to leagues 1 and 2 |
| seasons | 3 | All belong to competitions 1 and 2 |
| teams | 7 | All belong to seasons |
| divisions | 9 | All belong to seasons |
| season_drivers | 150 | All season registrations |
| rounds | 20 | All rounds |
| races | 32 | All races |
| race_results | 709 | All race results |

### Entity Hierarchy (Foreign Key Dependencies)

```
1. users (no dependencies)
2. leagues (depends on: users)
3. drivers (no dependencies)
4. league_drivers (depends on: leagues, drivers)
5. competitions (depends on: leagues, platforms)
6. seasons (depends on: competitions, users)
7. teams (depends on: seasons)
8. divisions (depends on: seasons)
9. season_drivers (depends on: seasons, league_drivers, teams, divisions)
10. rounds (depends on: seasons, platform_tracks, users)
11. races (depends on: rounds, races for self-ref)
12. race_results (depends on: races, season_drivers, divisions)
```

---

## Implementation Phases

### Phase 1: Update Generator Script Structure

**Files to modify:**
- `/var/www/generate_backup_seeders.php`

**Tasks:**

1.1. Add filter capability to export only data for users 1 and 3:
```php
// Define user IDs to export
$userIds = [1, 3];

// Get league IDs owned by these users
$leagueIds = DB::table('leagues')
    ->whereIn('owner_user_id', $userIds)
    ->pluck('id')
    ->toArray();

// Get competition IDs for these leagues
$competitionIds = DB::table('competitions')
    ->whereIn('league_id', $leagueIds)
    ->pluck('id')
    ->toArray();

// Get season IDs for these competitions
$seasonIds = DB::table('seasons')
    ->whereIn('competition_id', $competitionIds)
    ->pluck('id')
    ->toArray();
```

1.2. Add new seeder generators for missing tables:
- `UsersBackupSeeder.php` - Export users 1 and 3
- `LeaguesBackupSeeder.php` - Export leagues owned by users 1 and 3
- `DriversBackupSeeder.php` - Export all drivers referenced by league_drivers
- `LeagueDriversBackupSeeder.php` - Export league_drivers for leagues 1 and 2
- `CompetitionsBackupSeeder.php` - Export competitions for leagues 1 and 2

### Phase 2: Create New Seeder Files

**Files to create:**
- `/var/www/database/seeders/Backup/UsersBackupSeeder.php`
- `/var/www/database/seeders/Backup/LeaguesBackupSeeder.php`
- `/var/www/database/seeders/Backup/DriversBackupSeeder.php`
- `/var/www/database/seeders/Backup/LeagueDriversBackupSeeder.php`
- `/var/www/database/seeders/Backup/CompetitionsBackupSeeder.php`

**Seeder column specifications:**

2.1. **UsersBackupSeeder** (users table):
```php
$columns = [
    'id', 'first_name', 'last_name', 'alias', 'uuid', 'status', 'is_admin',
    'email', 'email_verified_at', 'password', 'remember_token',
    'created_at', 'updated_at', 'deleted_at'
];
```
Filter: `WHERE id IN (1, 3)`

2.2. **LeaguesBackupSeeder** (leagues table):
```php
$columns = [
    'id', 'owner_user_id', 'name', 'slug', 'description', 'logo_path', 'banner_path',
    'website', 'discord_url', 'youtube_handle', 'twitch_handle', 'twitter_handle',
    'facebook_handle', 'status', 'created_at', 'updated_at', 'deleted_at'
];
```
Filter: `WHERE owner_user_id IN (1, 3)`

2.3. **DriversBackupSeeder** (drivers table):
```php
$columns = [
    'id', 'first_name', 'last_name', 'display_name', 'email', 'phone',
    'discord_username', 'discord_id', 'platform_psn_id', 'platform_xbox_gamertag',
    'platform_steam_id', 'platform_ea_id', 'platform_iracing_id',
    'status', 'created_at', 'updated_at', 'deleted_at'
];
```
Filter: `WHERE id IN (SELECT DISTINCT driver_id FROM league_drivers WHERE league_id IN (1, 2))`

2.4. **LeagueDriversBackupSeeder** (league_drivers table):
```php
$columns = [
    'id', 'league_id', 'driver_id', 'driver_number', 'status',
    'league_notes', 'added_to_league_at', 'updated_at'
];
```
Filter: `WHERE league_id IN (1, 2)`

2.5. **CompetitionsBackupSeeder** (competitions table):
```php
$columns = [
    'id', 'league_id', 'platform_id', 'name', 'slug', 'description',
    'logo_path', 'car_class', 'status', 'created_by_user_id',
    'created_at', 'updated_at', 'deleted_at'
];
```
Filter: `WHERE league_id IN (1, 2)`

### Phase 3: Update Existing Seeders with Filters

**Files to modify:**
- `/var/www/generate_backup_seeders.php` (seeder generation for existing tables)

3.1. Update `SeasonsBackupSeeder` filter:
```php
WHERE competition_id IN ($competitionIds)
```

3.2. Update `TeamsBackupSeeder` filter:
```php
WHERE season_id IN ($seasonIds)
```

3.3. Update `DivisionsBackupSeeder` filter:
```php
WHERE season_id IN ($seasonIds)
```

3.4. Update `SeasonDriversBackupSeeder` filter:
```php
WHERE season_id IN ($seasonIds)
```

3.5. Update `RoundsBackupSeeder` filter:
```php
WHERE season_id IN ($seasonIds)
```

3.6. Update `RacesBackupSeeder` filter:
```php
WHERE round_id IN (SELECT id FROM rounds WHERE season_id IN ($seasonIds))
```

3.7. Update `RaceResultsBackupSeeder` filter:
```php
WHERE race_id IN (
    SELECT id FROM races WHERE round_id IN (
        SELECT id FROM rounds WHERE season_id IN ($seasonIds)
    )
)
```

### Phase 4: Update DatabaseBackupSeeder

**Files to modify:**
- `/var/www/database/seeders/Backup/DatabaseBackupSeeder.php`

4.1. Add new seeders to the execution order:
```php
// New dependency order (12 steps):
// 1. Users (no dependencies)
// 2. Leagues (depends on: users)
// 3. Drivers (no dependencies)
// 4. League Drivers (depends on: leagues, drivers)
// 5. Competitions (depends on: leagues, platforms)
// 6. Seasons (depends on: competitions, users)
// 7. Teams (depends on: seasons)
// 8. Divisions (depends on: seasons)
// 9. Season Drivers (depends on: seasons, league_drivers, teams, divisions)
// 10. Rounds (depends on: seasons, platform_tracks, users)
// 11. Races (depends on: rounds, races for self-ref)
// 12. Race Results (depends on: races, season_drivers, divisions)
```

### Phase 5: Update README

**Files to modify:**
- `/var/www/database/seeders/Backup/README.md` (auto-generated by script)

The README will be auto-generated by the script with updated:
- Table list with new tables
- Record counts
- Dependency order documentation
- Prerequisites section (now self-contained for users 1 and 3)

### Phase 6: Verification

6.1. Run the generator script:
```bash
php generate_backup_seeders.php
```

6.2. Test restoration on fresh database:
```bash
php artisan migrate:fresh
php artisan db:seed --class=PlatformSeeder
php artisan db:seed --class=PlatformTrackLocationSeeder
php artisan db:seed --class=PlatformTrackSeeder
php artisan db:seed --class="Database\Seeders\Backup\DatabaseBackupSeeder"
```

6.3. Verify data integrity:
```sql
-- Count verification
SELECT 'users' as tbl, COUNT(*) FROM users WHERE id IN (1, 3)
UNION ALL SELECT 'leagues', COUNT(*) FROM leagues WHERE owner_user_id IN (1, 3)
-- ... etc
```

---

## Scope

### In Scope
- Export users 1 and 3
- Export leagues owned by users 1 and 3
- Export all drivers referenced by those leagues
- Export league_drivers for those leagues
- Export competitions for those leagues
- Export seasons, teams, divisions, season_drivers, rounds, races, race_results for those competitions/seasons
- Update DatabaseBackupSeeder with correct dependency order
- Update README with new documentation

### Out of Scope
- Media files (handled separately by Spatie Media Library)
- Activity logs
- Sessions/password reset tokens
- League managers (assuming users 1 and 3 are the owners)
- Admin accounts (separate authentication system)
- Notification logs, contacts

---

## Prerequisites

After running the backup seeders, the following must exist (from other seeders):
- **platforms** table - Run `PlatformSeeder` first
- **platform_track_locations** table - Run `PlatformTrackLocationSeeder` first
- **platform_tracks** table - Run `PlatformTrackSeeder` first

The backup seeders are now self-contained for all racing domain data.

---

## Rollback Strategy

If issues occur:
1. The old `generate_backup_seeders.php` can be restored from git
2. Individual seeder files can be regenerated
3. Database can be reset with `php artisan migrate:fresh --seed`

---

## Success Criteria

### Automated Verification:
- [x] Script runs without errors: `php generate_backup_seeders.php`
- [x] All 12 seeder files are generated in `database/seeders/Backup/`
- [x] README.md is updated with correct record counts
- [x] PHP syntax is valid: `php -l database/seeders/Backup/*.php`
- [x] PHPCS passes: `composer run phpcs -- database/seeders/Backup/` (warnings only - no errors)
- [x] Fresh restore works: `php artisan migrate:fresh && php artisan db:seed --class=PlatformSeeder && php artisan db:seed --class=PlatformTrackLocationSeeder && php artisan db:seed --class=PlatformTrackSeeder && php artisan db:seed --class="Database\Seeders\Backup\DatabaseBackupSeeder"`

### Manual Verification:
- [ ] Users 1 and 3 can log in after restore
- [ ] Leagues appear correctly in admin dashboard
- [ ] Season data displays correctly with drivers, teams, divisions
- [ ] Race results display correctly with proper relationships
