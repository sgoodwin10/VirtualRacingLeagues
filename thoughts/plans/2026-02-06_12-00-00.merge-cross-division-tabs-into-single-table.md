# Merge Cross-Division Results Into Single Sortable Table

## Overview

Replace the 3 separate cross-division tabs (Qualifying Times, Race Times, Fastest Laps) in `RoundAccordion.vue` with a single "Cross Division Times" tab that shows one combined VrlDataTable with sortable columns for qualifying time, race time, and fastest lap. This mirrors the pattern used in `SeasonDetailWhiteLabelView.vue`.

## Current State

- `RoundAccordion.vue` (line 56-154) renders 4 tabs when `raceTimesRequired=true`:
  - "Round Results" — division results with standings
  - "Qualifying Times" — `CrossDivisionResultsTable` with `qualifying_results`
  - "Race Times" — `CrossDivisionResultsTable` with `race_time_results`
  - "Fastest Laps" — `CrossDivisionResultsTable` with `fastest_lap_results`
- `CrossDivisionResultsTable.vue` shows: Pos, Driver, Division, Time (single column)
- Each tab shows a separate single-time-type table

## Target State

- `RoundAccordion.vue` renders 2 tabs when `raceTimesRequired=true`:
  - "Round Results" — unchanged
  - "Cross Division Times" — new combined sortable table
- `CrossDivisionResultsTable.vue` is **replaced** with a new `CrossDivisionAllTimesTable.vue` that shows:
  - Pos (#), Driver, Division, Qualifying Time (sortable), Race Time (sortable), Fastest Lap (sortable)
  - Clicking a column header sorts the table by that time (ascending — fastest first)
  - First place in each column shows absolute time, others show `+diff`
  - Default sort: qualifying time

## Files to Modify

| File | Action | Description |
|------|--------|-------------|
| `resources/public/js/components/leagues/rounds/CrossDivisionResultsTable.vue` | **DELETE** | Old single-time component, no longer needed |
| `resources/public/js/components/leagues/rounds/CrossDivisionResultsTable.test.ts` | **DELETE** | Old tests |
| `resources/public/js/components/leagues/rounds/CrossDivisionAllTimesTable.vue` | **CREATE** | New combined sortable table |
| `resources/public/js/components/leagues/rounds/CrossDivisionAllTimesTable.test.ts` | **CREATE** | New tests |
| `resources/public/js/components/leagues/rounds/RoundAccordion.vue` | **MODIFY** | Replace 3 tabs with 1 "Cross Division Times" tab |
| `resources/public/js/components/leagues/rounds/RoundAccordion.test.ts` | **MODIFY** | Update tab tests |

## Detailed Implementation

### Phase 1: Create `CrossDivisionAllTimesTable.vue`

**File**: `resources/public/js/components/leagues/rounds/CrossDivisionAllTimesTable.vue`

**Props** (receives all 3 result sets at once):
```typescript
interface Props {
  qualifyingResults: CrossDivisionResult[] | null;
  raceTimeResults: CrossDivisionResult[] | null;
  fastestLapResults: CrossDivisionResult[] | null;
  raceEvents: RaceEventResults[];
  divisions: Array<{ id: number; name: string }>;
}
```

**Internal state**:
```typescript
type SortColumn = 'qualifying' | 'race' | 'fastest';
const sortColumn = ref<SortColumn>('qualifying');
```

**Data logic** (ported from `SeasonDetailWhiteLabelView.vue` lines 1461-1677):

1. Build `raceResultsMap` and `divisionsMap` from props (same as current)
2. `getCombinedData()` computed:
   - Create a `Map<string, CombinedTimeEntry>` keyed by `${driverName}-${divisionId}`
   - Iterate qualifying results → set `qualifyingTimeMs`
   - Iterate race time results → set `raceTimeMs`
   - Iterate fastest lap results → set `fastestLapMs`
   - Find fastest time in each category
   - Format times: absolute for fastest, `+diff` for others, `-` for null
3. `sortedData` computed:
   - Clone combined data, sort by `sortColumn.value` ascending (nulls to bottom)
   - Recalculate position (index + 1) after sort

**Interface for combined entry** (matches `SeasonDetailWhiteLabelView.vue` line 1446):
```typescript
interface CombinedTimeEntry {
  position: number;
  driverName: string;
  divisionId: number | null;
  divisionName: string | null;
  qualifyingTimeMs: number | null;
  raceTimeMs: number | null;
  fastestLapMs: number | null;
  qualifyingFormatted: string;
  raceFormatted: string;
  fastestLapFormatted: string;
}
```

**Template** — uses VrlDataTable with custom column headers that are clickable for sorting:

```vue
<VrlDataTable
  :value="sortedData"
  :podium-highlight="true"
  position-field="position"
  :paginated="false"
  :hoverable="true"
  :striped="false"
  empty-message="No times available"
  table-class="[&_th]:!p-3 [&_td]:!p-3"
>
  <!-- Position Column -->
  <Column field="position" header="#" style="width: 60px">
    <template #body="{ data }">
      <VrlPositionCell :position="data.position" />
    </template>
  </Column>

  <!-- Driver Column -->
  <Column field="driverName" header="Driver" class="min-w-[200px]">
    <template #body="{ data }">
      <span class="font-body font-medium text-[var(--text-primary)] text-lg">
        {{ data.driverName }}
      </span>
    </template>
  </Column>

  <!-- Division Column (conditional) -->
  <Column v-if="hasDivisions" field="divisionName" header="Division" style="width: 180px">
    <template #body="{ data }">
      <!-- Same division badge as current CrossDivisionResultsTable -->
    </template>
  </Column>

  <!-- Qualifying Time Column (sortable header) -->
  <Column field="qualifyingFormatted" style="width: 140px; text-align: right">
    <template #header>
      <div class="sortable-header" :class="{ 'is-sorted': sortColumn === 'qualifying' }" @click="setSortColumn('qualifying')">
        <span class="hidden md:block">Qualifying</span>
        <span class="block md:hidden">Quali</span>
        <span v-if="sortColumn === 'qualifying'" class="sort-arrow">&#9650;</span>
      </div>
    </template>
    <template #body="{ data }">
      <span class="font-[family-name:var(--font-mono)] font-bold text-[var(--text-primary)] pr-3 text-lg">
        {{ data.qualifyingFormatted }}
      </span>
    </template>
  </Column>

  <!-- Race Time Column (sortable header) -->
  <Column field="raceFormatted" style="width: 140px; text-align: right">
    <template #header>
      <div class="sortable-header" :class="{ 'is-sorted': sortColumn === 'race' }" @click="setSortColumn('race')">
        <span class="hidden md:block">Race Time</span>
        <span class="block md:hidden">Race</span>
        <span v-if="sortColumn === 'race'" class="sort-arrow">&#9650;</span>
      </div>
    </template>
    <template #body="{ data }">
      <span class="font-[family-name:var(--font-mono)] font-bold text-[var(--text-primary)] pr-3 text-lg">
        {{ data.raceFormatted }}
      </span>
    </template>
  </Column>

  <!-- Fastest Lap Column (sortable header) -->
  <Column field="fastestLapFormatted" style="width: 140px; text-align: right">
    <template #header>
      <div class="sortable-header" :class="{ 'is-sorted': sortColumn === 'fastest' }" @click="setSortColumn('fastest')">
        <span class="hidden md:block">Fastest Lap</span>
        <span class="block md:hidden">FL</span>
        <span v-if="sortColumn === 'fastest'" class="sort-arrow">&#9650;</span>
      </div>
    </template>
    <template #body="{ data }">
      <span class="font-[family-name:var(--font-mono)] font-bold text-[var(--text-primary)] pr-3 text-lg">
        {{ data.fastestLapFormatted }}
      </span>
    </template>
  </Column>
</VrlDataTable>
```

**Sorting styles** (scoped CSS):
```css
.sortable-header {
  cursor: pointer;
  user-select: none;
  display: flex;
  align-items: center;
  gap: 0.25rem;
  transition: color 0.15s ease;
}

.sortable-header:hover {
  color: var(--text-primary);
}

.sortable-header.is-sorted {
  color: var(--cyan);
}

.sort-arrow {
  font-size: 0.6rem;
}
```

**Time formatting functions** — reuse the same `formatTime()` and `formatTimeDifference()` from the current `CrossDivisionResultsTable.vue` (lines 153-188).

**Important behavior note**: When the sort column changes, the time diffs should be recalculated relative to the fastest time **per column** (not relative to the sorted order). The formatted times are computed once from the raw data, and sorting only changes the row order + position numbers. This matches the SeasonDetailWhiteLabelView behavior where diffs are always relative to the fastest time in each column regardless of sort.

### Phase 2: Update `RoundAccordion.vue`

**Changes to `mainTabs` computed** (line 260-286):
```typescript
const mainTabs = computed((): TabItem[] => {
  const tabs: TabItem[] = [
    { key: 'round-results', label: 'Round Results' },
  ];

  if (props.raceTimesRequired) {
    tabs.push({ key: 'cross-division-times', label: 'Cross Division Times' });
  }

  return tabs;
});
```

**Replace the 3 tab content blocks** (lines 129-154) with a single block:
```vue
<!-- Cross Division Times Tab Content -->
<div v-if="activeMainTab === 'cross-division-times' && roundData">
  <CrossDivisionAllTimesTable
    :qualifying-results="roundData.qualifying_results"
    :race-time-results="roundData.race_time_results"
    :fastest-lap-results="roundData.fastest_lap_results"
    :race-events="raceEvents"
    :divisions="divisions"
  />
</div>
```

**Update imports**:
- Remove: `import CrossDivisionResultsTable from '...'`
- Add: `import CrossDivisionAllTimesTable from '@public/components/leagues/rounds/CrossDivisionAllTimesTable.vue'`

**Update mobile tab labels** (lines 62-79):
Replace the multi-condition ternary with:
```vue
<template #tab-label="{ tab }">
  <span class="hidden md:block">{{ tab.label }}</span>
  <span class="block md:hidden">
    {{ tab.label === 'Round Results' ? 'Results' : 'Times' }}
  </span>
</template>
```

### Phase 3: Create `CrossDivisionAllTimesTable.test.ts`

**Test cases**:
1. **Rendering**: Renders VrlDataTable with combined results
2. **Columns**: Has position, driver, division (conditional), qualifying, race time, fastest lap columns
3. **Data merging**: Correctly merges qualifying, race, and fastest lap results per driver
4. **Time formatting**: First place shows absolute time, others show `+diff`
5. **Sorting**: Default sort is qualifying; clicking race/fastest changes sort
6. **Position updates**: Position numbers update when sort column changes
7. **Null handling**: Missing time shows `-`
8. **Empty state**: Shows empty message when no results
9. **Division badges**: Shows correct styling per division

### Phase 4: Update `RoundAccordion.test.ts`

- Remove/update the `CrossDivisionResultsTable` stub reference (line 143)
- Update to reference `CrossDivisionAllTimesTable` instead
- Update tab test to check for single "Cross Division Times" tab instead of 3 separate tabs

### Phase 5: Delete Old Files

- Delete `resources/public/js/components/leagues/rounds/CrossDivisionResultsTable.vue`
- Delete `resources/public/js/components/leagues/rounds/CrossDivisionResultsTable.test.ts`

## Out of Scope

- Changes to the backend API — the 3 separate `CrossDivisionResult[]` arrays remain as-is
- Changes to SeasonDetailWhiteLabelView.vue — already has the correct pattern
- Changes to VrlDataTable — we use custom header slots for sort behavior
- Changes to the "Round Results" tab or any other components

## Success Criteria

### Automated Verification:
- [x] All Vitest tests pass: `.claude/support/scripts/vitests_run_tests.sh` (29/29 new tests pass; 6 pre-existing failures in unrelated files)
- [x] JavaScript/TypeScript ESLint analysis passes: `npm run lint` and `npm run lint:fix`
- [x] JavaScript/TypeScript Formatting passes: `npm run format`
- [x] TypeScript type-check passes: `npm run type-check` (pre-existing vite.config.ts errors only)

### Manual Verification:
- [ ] When `raceTimesRequired` is true, only 2 tabs appear: "Round Results" and "Cross Division Times"
- [ ] The combined table shows all 3 time columns (Qualifying, Race Time, Fastest Lap)
- [ ] Clicking a column header sorts the table by that column (fastest first)
- [ ] The sorted column header is visually highlighted (cyan color)
- [ ] Position numbers (#) update correctly when sort changes
- [ ] First place per column shows absolute time (e.g., `01:25.456`)
- [ ] Other positions per column show diff (e.g., `+00.333`)
- [ ] Division badges display correctly when divisions exist
- [ ] Division column is hidden when no divisions
- [ ] Drivers missing a time type show `-` in that column
- [ ] Mobile responsive labels work (abbreviated headers)
- [ ] Podium highlighting (gold/silver/bronze row tints) works based on current sort position
