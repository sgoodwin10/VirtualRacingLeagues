# Implementation Plan: Update CrossDivisionAllTimesTable to Show Times with Gap

## Overview

Update the qualifying, race time, and fastest lap columns in `CrossDivisionAllTimesTable.vue` to display the actual time for all drivers, with the gap to the leader shown in brackets beneath for non-leaders.

## Current Behavior

- **Leader**: Shows absolute time (e.g., `01:25.456`)
- **Others**: Shows only the gap (e.g., `+00.333`)

## Target Behavior

- **Leader**: Shows absolute time only (e.g., `01:25.456`)
- **Others**: Shows absolute time on first line, gap in brackets beneath:
  ```
  01:25.789
  (+00.333)
  ```

## Implementation Details

### Agent: `dev-fe-public`

### File to Modify

`resources/public/js/components/leagues/rounds/CrossDivisionAllTimesTable.vue`

---

## Phase 1: Update Data Structure

### Changes to `CombinedTimeEntry` Interface (lines 142-153)

Add new formatted fields to store both absolute time and gap separately:

```typescript
interface CombinedTimeEntry {
  position: number;
  driverName: string;
  divisionId: number | null;
  divisionName: string | null;
  qualifyingTimeMs: number | null;
  raceTimeMs: number | null;
  fastestLapMs: number | null;
  // Existing fields (keep for backwards compatibility with sorting logic that uses these)
  qualifyingFormatted: string;
  raceFormatted: string;
  fastestLapFormatted: string;
  // NEW: Separate absolute time and gap fields
  qualifyingTimeAbsolute: string;
  qualifyingGap: string | null;  // null for leader
  raceTimeAbsolute: string;
  raceGap: string | null;        // null for leader
  fastestLapAbsolute: string;
  fastestLapGap: string | null;  // null for leader
}
```

---

## Phase 2: Update Data Population Logic

### Changes to `combinedData` Computed Property (lines 181-259)

1. **Update initial entry creation** (around line 192-203) to initialize new fields:

```typescript
entryMap.set(key, {
  position: 0,
  driverName,
  divisionId,
  divisionName,
  qualifyingTimeMs: null,
  raceTimeMs: null,
  fastestLapMs: null,
  qualifyingFormatted: '-',
  raceFormatted: '-',
  fastestLapFormatted: '-',
  // NEW fields
  qualifyingTimeAbsolute: '-',
  qualifyingGap: null,
  raceTimeAbsolute: '-',
  raceGap: null,
  fastestLapAbsolute: '-',
  fastestLapGap: null,
});
```

2. **Update formatting loop** (around line 252-256) to populate both absolute time and gap:

```typescript
// Format times: absolute for all, gap for non-leaders
for (const entry of entries) {
  // Qualifying
  entry.qualifyingTimeAbsolute = entry.qualifyingTimeMs != null ? formatTime(entry.qualifyingTimeMs) : '-';
  entry.qualifyingGap = entry.qualifyingTimeMs != null && entry.qualifyingTimeMs !== fastestQualifying && isFinite(fastestQualifying)
    ? formatTimeDifference(entry.qualifyingTimeMs - fastestQualifying)
    : null;

  // Race time
  entry.raceTimeAbsolute = entry.raceTimeMs != null ? formatTime(entry.raceTimeMs) : '-';
  entry.raceGap = entry.raceTimeMs != null && entry.raceTimeMs !== fastestRace && isFinite(fastestRace)
    ? formatTimeDifference(entry.raceTimeMs - fastestRace)
    : null;

  // Fastest lap
  entry.fastestLapAbsolute = entry.fastestLapMs != null ? formatTime(entry.fastestLapMs) : '-';
  entry.fastestLapGap = entry.fastestLapMs != null && entry.fastestLapMs !== fastestLap && isFinite(fastestLap)
    ? formatTimeDifference(entry.fastestLapMs - fastestLap)
    : null;

  // Keep legacy formatted fields for any existing usage (not strictly needed but safe)
  entry.qualifyingFormatted = formatColumnTime(entry.qualifyingTimeMs, fastestQualifying);
  entry.raceFormatted = formatColumnTime(entry.raceTimeMs, fastestRace);
  entry.fastestLapFormatted = formatColumnTime(entry.fastestLapMs, fastestLap);
}
```

---

## Phase 3: Update Template

### Update Qualifying Column Body (lines 68-74)

**From:**
```vue
<template #body="{ data }">
  <span
    class="font-[family-name:var(--font-mono)] font-bold text-[var(--text-primary)] pr-3 text-lg"
  >
    {{ data.qualifyingFormatted }}
  </span>
</template>
```

**To:**
```vue
<template #body="{ data }">
  <div class="text-right pr-3">
    <span class="font-[family-name:var(--font-mono)] font-bold text-[var(--text-primary)] text-lg">
      {{ data.qualifyingTimeAbsolute }}
    </span>
    <div
      v-if="data.qualifyingGap"
      class="font-[family-name:var(--font-mono)] text-[var(--text-secondary)] text-sm"
    >
      ({{ data.qualifyingGap }})
    </div>
  </div>
</template>
```

### Update Race Time Column Body (lines 90-96)

**From:**
```vue
<template #body="{ data }">
  <span
    class="font-[family-name:var(--font-mono)] font-bold text-[var(--text-primary)] pr-3 text-lg"
  >
    {{ data.raceFormatted }}
  </span>
</template>
```

**To:**
```vue
<template #body="{ data }">
  <div class="text-right pr-3">
    <span class="font-[family-name:var(--font-mono)] font-bold text-[var(--text-primary)] text-lg">
      {{ data.raceTimeAbsolute }}
    </span>
    <div
      v-if="data.raceGap"
      class="font-[family-name:var(--font-mono)] text-[var(--text-secondary)] text-sm"
    >
      ({{ data.raceGap }})
    </div>
  </div>
</template>
```

### Update Fastest Lap Column Body (lines 112-118)

**From:**
```vue
<template #body="{ data }">
  <span
    class="font-[family-name:var(--font-mono)] font-bold text-[var(--text-primary)] pr-3 text-lg"
  >
    {{ data.fastestLapFormatted }}
  </span>
</template>
```

**To:**
```vue
<template #body="{ data }">
  <div class="text-right pr-3">
    <span class="font-[family-name:var(--font-mono)] font-bold text-[var(--text-primary)] text-lg">
      {{ data.fastestLapAbsolute }}
    </span>
    <div
      v-if="data.fastestLapGap"
      class="font-[family-name:var(--font-mono)] text-[var(--text-secondary)] text-sm"
    >
      ({{ data.fastestLapGap }})
    </div>
  </div>
</template>
```

---

## Phase 4: Update Tests

### File: `resources/public/js/components/leagues/rounds/CrossDivisionAllTimesTable.test.ts`

### Test Updates Required

1. **Update "Time Formatting" describe block** (lines 340-410):

   - Modify test "should show absolute time for fastest in each column" to check `qualifyingTimeAbsolute` etc.
   - Modify test "should show +diff for non-fastest times" to check `qualifyingGap` etc.
   - Add new test: "should show null gap for leader"
   - Add new test: "should show gap in brackets for non-leaders"

2. **Add new describe block** for visual rendering:

```typescript
describe('Time Display with Gap', () => {
  it('should show absolute time for all drivers', () => {
    wrapper = mount(CrossDivisionAllTimesTable, {
      props: {
        qualifyingResults: mockQualifyingResults,
        raceTimeResults: mockRaceTimeResults,
        fastestLapResults: mockFastestLapResults,
        raceEvents: mockRaceEvents,
        divisions: mockDivisions,
      },
    });

    const dataTable = wrapper.findComponent({ name: 'VrlDataTable' });
    const data = dataTable.props('value') as any[];

    const driver1 = data.find((d: any) => d.driverName === 'Driver 1');
    const driver2 = data.find((d: any) => d.driverName === 'Driver 2');

    // Both drivers should have absolute times
    expect(driver1.qualifyingTimeAbsolute).toBe('01:25.456');
    expect(driver2.qualifyingTimeAbsolute).toBe('01:25.789');
  });

  it('should show null gap for leader (fastest time)', () => {
    wrapper = mount(CrossDivisionAllTimesTable, {
      props: {
        qualifyingResults: mockQualifyingResults,
        raceTimeResults: mockRaceTimeResults,
        fastestLapResults: mockFastestLapResults,
        raceEvents: mockRaceEvents,
        divisions: mockDivisions,
      },
    });

    const dataTable = wrapper.findComponent({ name: 'VrlDataTable' });
    const data = dataTable.props('value') as any[];

    const driver1 = data.find((d: any) => d.driverName === 'Driver 1');

    // Driver 1 has fastest qualifying (85456ms) - should have null gap
    expect(driver1.qualifyingGap).toBeNull();
  });

  it('should show gap for non-leaders', () => {
    wrapper = mount(CrossDivisionAllTimesTable, {
      props: {
        qualifyingResults: mockQualifyingResults,
        raceTimeResults: mockRaceTimeResults,
        fastestLapResults: mockFastestLapResults,
        raceEvents: mockRaceEvents,
        divisions: mockDivisions,
      },
    });

    const dataTable = wrapper.findComponent({ name: 'VrlDataTable' });
    const data = dataTable.props('value') as any[];

    const driver2 = data.find((d: any) => d.driverName === 'Driver 2');

    // Driver 2 qualifying diff: 85789 - 85456 = 333ms
    expect(driver2.qualifyingGap).toBe('+00.333');
  });

  it('should render gap in parentheses beneath absolute time', () => {
    wrapper = mount(CrossDivisionAllTimesTable, {
      props: {
        qualifyingResults: mockQualifyingResults,
        raceTimeResults: mockRaceTimeResults,
        fastestLapResults: mockFastestLapResults,
        raceEvents: mockRaceEvents,
        divisions: mockDivisions,
      },
    });

    // Check that the template renders gap in parentheses
    const html = wrapper.html();
    expect(html).toContain('(+00.333)');
  });

  it('should not render gap row for leader', () => {
    wrapper = mount(CrossDivisionAllTimesTable, {
      props: {
        qualifyingResults: mockQualifyingResults,
        raceTimeResults: mockRaceTimeResults,
        fastestLapResults: mockFastestLapResults,
        raceEvents: mockRaceEvents,
        divisions: mockDivisions,
      },
    });

    const dataTable = wrapper.findComponent({ name: 'VrlDataTable' });
    const data = dataTable.props('value') as any[];

    // Leader should not have a gap value
    const leader = data.find((d: any) => d.qualifyingGap === null);
    expect(leader).toBeDefined();
  });
});
```

3. **Update existing tests** that check formatted values:

   - Test at line 359: Update to check `qualifyingTimeAbsolute` and `fastestLapAbsolute` instead of `qualifyingFormatted` and `fastestLapFormatted`
   - Test at line 384-389: Update to check `qualifyingGap` and `raceGap` instead of `qualifyingFormatted` and `raceFormatted`

---

## Files Modified

1. `resources/public/js/components/leagues/rounds/CrossDivisionAllTimesTable.vue`
2. `resources/public/js/components/leagues/rounds/CrossDivisionAllTimesTable.test.ts`

---

## Out of Scope

- Changes to other components
- Changes to the data types in `public.ts`
- Changes to backend API responses
- Creating new cell components (the change is simple enough to be inline)

---

## Success Criteria

### Automated Verification

- [ ] All existing tests pass: `.claude/support/scripts/vitests_run_tests.sh`
- [ ] New tests for time with gap display pass
- [ ] TypeScript type checking passes: `npm run type-check`
- [ ] ESLint passes: `npm run lint`

### Manual Verification

- [ ] Navigate to a round results page with cross-division times
- [ ] Verify leader row shows only absolute time (no gap in brackets)
- [ ] Verify non-leader rows show absolute time with gap in brackets beneath
- [ ] Verify sorting still works correctly when clicking column headers
- [ ] Verify gap styling uses secondary text color and smaller font size
- [ ] Verify mobile responsive display works correctly
